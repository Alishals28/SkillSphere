{% extends "admin/base_site.html" %}
{% load admin_urls %}

{% block title %}Dashboard - {{ block.super }}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #2196F3;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stat-change {
        font-size: 0.8em;
        margin-top: 5px;
    }
    
    .stat-change.positive { color: #4CAF50; }
    .stat-change.negative { color: #f44336; }
    
    .dashboard-charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
        color: #333;
    }
    
    .dashboard-tables {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    .table-container {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .dashboard-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .dashboard-table th,
    .dashboard-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .dashboard-table th {
        background: #f5f5f5;
        font-weight: bold;
    }
    
    .dashboard-table tbody tr:hover {
        background: #f9f9f9;
    }
    
    @media (max-width: 768px) {
        .dashboard-charts,
        .dashboard-tables {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>SkillSphere Admin Dashboard</h1>
    
    <!-- Key Statistics -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-number">{{ user_stats.total_users|floatformat:0 }}</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-change positive">+{{ user_stats.new_users_30d }} this month</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ user_stats.total_mentors|floatformat:0 }}</div>
            <div class="stat-label">Total Mentors</div>
            <div class="stat-change">{{ user_stats.active_users_30d }} active this month</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ session_stats.total_sessions|floatformat:0 }}</div>
            <div class="stat-label">Total Sessions</div>
            <div class="stat-change positive">+{{ session_stats.sessions_30d }} this month</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">${{ financial_stats.total_revenue|floatformat:2|default:"0.00" }}</div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-change positive">+${{ financial_stats.revenue_30d|floatformat:2|default:"0.00" }} this month</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ platform_stats.average_rating|floatformat:1 }}/5</div>
            <div class="stat-label">Average Rating</div>
            <div class="stat-change">{{ session_stats.completed_sessions }} rated sessions</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ session_stats.completion_rate|floatformat:1 }}%</div>
            <div class="stat-label">Completion Rate</div>
            <div class="stat-change">{{ session_stats.completed_sessions }}/{{ session_stats.total_sessions }}</div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="dashboard-charts">
        <div class="chart-container">
            <div class="chart-title">User Growth (Last 30 Days)</div>
            <canvas id="userGrowthChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Revenue Trend (Last 30 Days)</div>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- Data Tables -->
    <div class="dashboard-tables">
        <div class="table-container">
            <div class="chart-title">Top Performing Mentors</div>
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Mentor</th>
                        <th>Sessions</th>
                        <th>Earnings</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mentor in top_mentors %}
                    <tr>
                        <td>{{ mentor.full_name }}</td>
                        <td>{{ mentor.session_count|default:0 }}</td>
                        <td>${{ mentor.total_earnings|floatformat:2|default:"0.00" }}</td>
                        <td>{{ mentor.avg_rating|floatformat:1|default:"N/A" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-container">
            <div class="chart-title">Most Popular Skills</div>
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Skill</th>
                        <th>Sessions</th>
                        <th>Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    {% for skill in popular_skills %}
                    <tr>
                        <td>{{ skill.name }}</td>
                        <td>{{ skill.session_count|default:0 }}</td>
                        <td>${{ skill.revenue|floatformat:2|default:"0.00" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="dashboard-tables">
        <div class="table-container">
            <div class="chart-title">Recent Bookings</div>
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Learner</th>
                        <th>Mentor</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in recent_bookings %}
                    <tr>
                        <td>{{ booking.learner.full_name }}</td>
                        <td>{{ booking.mentor.full_name }}</td>
                        <td>{{ booking.subject|truncatechars:30 }}</td>
                        <td>{{ booking.status|title }}</td>
                        <td>{{ booking.created_at|date:"M j, Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">No recent bookings</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-container">
            <div class="chart-title">Recent Users</div>
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Joined</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in recent_users %}
                    <tr>
                        <td>{{ user.full_name }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.role|title }}</td>
                        <td>{{ user.created_at|date:"M j, Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4">No recent users</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// User Growth Chart
const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
const userGrowthChart = new Chart(userGrowthCtx, {
    type: 'line',
    data: {
        labels: {{ growth_data|safe }}.map(item => item.date),
        datasets: [{
            label: 'New Users',
            data: {{ growth_data|safe }}.map(item => item.new_users),
            borderColor: '#2196F3',
            backgroundColor: 'rgba(33, 150, 243, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Revenue Chart
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(revenueCtx, {
    type: 'bar',
    data: {
        labels: {{ growth_data|safe }}.map(item => item.date),
        datasets: [{
            label: 'Daily Revenue',
            data: {{ growth_data|safe }}.map(item => item.revenue),
            backgroundColor: '#4CAF50',
            borderColor: '#4CAF50',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
